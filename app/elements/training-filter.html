<link rel="import" href="elements.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<script src="../scripts/md5.js"></script>

<dom-module id="training-filter">
  <style is="custom-style" include="common-styles">
    span {
      padding: 0 8px;
    }

    paper-card {
      padding: 1em;
      margin-bottom: 1em;
    }

    #textFilter {
      width: 15em;
    }

    .eventDetails {
      margin-left: 2em;
    }

    paper-checkbox {
      margin-right: 1em;
    }

    @media all and (min-width: 700px) {
      /* if we have a wide enough screen, keep the checkboxes with the label */
      #selectCampus,
      #selectMonth {
        white-space: nowrap;
      }
    }
    @media all and (max-width: 700px) {
      #selectCampus,
      #selectMonth {
        display: block;
      }
    }

  </style>

  <template>
    <uqlibrary-api-training id="trainingApi" on-uqlibrary-api-training="_setupTrainingData"></uqlibrary-api-training>

    <paper-card elevation="1" id="filter">
      <span id="selectCampus">
        <template is="dom-if" if="[[areMultipleCampuses]]">
          <span>Choose a campus:</span>
          <template id="campustemplate" is="dom-repeat" items="{{selectedCampusList}}" as="campus">
            <paper-checkbox checked="{{campus.selected}}" on-change="refilterData">{{campus.name}}</paper-checkbox>
          </template>
        </template>
        <template is="dom-if" if="[[!areMultipleCampuses]]">
          <p>Training events currently only at: {{campusList}}</p>
        </template>
      </span>

      <span id="selectMonth">
        <template is="dom-if" if="[[areMultipleMonths]]">
          <span>Choose a month:</span>
          <template is="dom-repeat" items="{{selectedMonthList}}" as="month">
            <paper-checkbox checked="{{month.selected}}" on-change="refilterData">{{month.display}}</paper-checkbox>
          </template>
        </template>
        <template is="dom-if" if="[[!areMultipleCampuses]]">
          <p>Training events currently only at: {{campusList}}</p>
        </template>
      </span>

      <span id="textFilterHolder">
        <paper-input id="textFilter" placeholder="Restrict result by text" value="{{textFilter}}"></paper-input>
      </span>

      <paper-button on-tap="resetFilters">Reset filters</paper-button>
    </paper-card>


  </template>

  <script>
    (function () {
      Polymer({
        is: 'training-filter',

        properties: {

          /*
           * all the campuses that are provided in the data
           * (matches to filter options displayed)
           */
          displayCampusList: {
            type: Array,
            value: []
          },
          /*
           * the campuses that are currently selected in the filter
           */
          selectedCampusList: {
            type: Array,
            value: [],
            notify: true,
            observer: "refilterData"
          },
          /*
           * true if more than one campus can be chosen from
           * used to hide the campuses filter block when there is only one campus
           */
          areMultipleCampuses: Boolean,

          /*
           * all the months in the data set
           * used to display the months that can be filtered
           */
          displayMonthList: {
            type: Array,
            value: []
          },
          /*
           * the months that are currently selected in the filter
           */
          selectedMonthList: {
            type: Array,
            value: [],
            notify: true,
            observer: "refilterData"
          },
          /*
           * true if more than one month can be chosen from
           * used to hide the months filter block when there is only one month
           */
          areMultipleMonths: Boolean,

          /*
           * the text field where the user can filter data
           * case insensitive
           */
          textFilter: {
            type: String,
            observer: "refilterData"
          },

          /*
           * complete set of events, taken from the supplied data
           */
          allEvents:  Array,

          /*
           * the events that match the selected filters
           */
          displayableEvents: Array
        },

        ready: function () {
          /* load the data (from uqlibrary_api) */
          this.$.trainingApi.get();
        },

        /*
         * setup the data on first load
         */
        _setupTrainingData: function (e) {
          var events = e.detail;
          var _campuses = [];
          var _months = [];
          var processedEvents = [];

          var that = this;

          events.forEach(function(event){

            event.filterDate = "";
            // setup the formatted date for display
            if (event.start) {
              event.filterDate = moment(event.start).format('MMM YYYY');
            }

            //set up all categories
            if (event.labels) {
              event.labels.forEach(function(label){
                if (!processedEvents[label.id]) {
                  label.events = [];
                  label.displayName = label.name.replace(/.*\./ , '');

                  processedEvents[label.id] = label;
                }

                if (!label.events)
                  label = processedEvents[label.id];

                //create display string for start date
                var startDate = new Date(event.start);
                event.formattedDate = startDate.toDateString();

                //add this event to the array of labels
                label.events.push(event);

              });
            }


            //setup all campuses
            if (event.categories && event.categories.campus) {
              event.categories.campus.forEach(function(campus){
                if (_campuses.indexOf(campus) < 0) {
                  _campuses.push(campus);
                }
              });
            }

            // get the list of available months (in which triaining will be offered)
            if (typeof (_months) === 'object' && event.filterDate != "" && _months.indexOf(event.filterDate) < 0) {
              _months.push(event.filterDate);
            }

          });

          this.campusList = _campuses;

          // store the possible list of campuses
          this.displayCampusList = _campuses;
          this.areMultipleCampuses = (this.displayCampusList !== undefined && this.displayCampusList.length > 1);

          // load the campus filter
          _campuses.forEach(function (aCampus) {
            var newCampus = {};
            newCampus.name = aCampus;
            newCampus.selected = true;
            that.selectedCampusList.push(newCampus);
          });

          this.displayMonthList = _months;
          this.areMultipleMonths = (this.displayMonthList !== undefined && this.displayMonthList.length > 1);
          // load the month display filter
          _months.forEach(function (aMonth) {
            var newMonth = {};
            newMonth.display = aMonth;
            newMonth.selected = true;
            that.selectedMonthList.push(newMonth);
          });
          this.displayableEvents = processedEvents; // do we need to set this here? refilter overrides it?
          this.allEvents = processedEvents;
          this.refilterData();
        },


        /*
         * resets all the filters to their default position
         * and redisplays the full data set
         */
        resetFilters: function () {
          var that = this;
          this.selectedCampusList.forEach(function (c, index) {
            that.set("selectedCampusList." + index + ".selected", true);
          });

          this.selectedMonthList.forEach(function (m, index) {
            that.set("selectedMonthList." + index + ".selected", true);
          });

          that.set("textFilter", "");

          this.fire('training-filter', this.displayableEvents);
        },

        /*
         * if the campus of the event matches one of the campuses selected in the filter, return true
         * otherwise, return false
         * we are assuming there is only ever one entry in event.categories.campus
         */
        _eventIsOnAFilteredCampus: function (_event) {
          if (!(_event.categories && _event.categories.campus)) {
            return false;
          }

          eventCampus = _event.categories.campus;

          var _displayable = false;
          if (this.selectedCampusList !== undefined && 0 < this.selectedCampusList.length) {
            this.selectedCampusList.forEach(function (campusFilter) {
              if (eventCampus == campusFilter.name && campusFilter.selected) {
                _displayable = true;
              }
            });
          }
          return _displayable;
        },

        /*
         * returns true if the event's start date is currently ticked in the filter
         */
        _eventIsInAFilteredMonth: function (event) {
          var _displayable = false;
          if (this.selectedMonthList !== undefined && 0 < this.selectedMonthList.length) {
            this.selectedMonthList.forEach(function (monthFilter) {
              if (event.filterDate && event.filterDate == monthFilter.display
                      && monthFilter.selected) {
                _displayable = true;
              }
            });
          }
          return _displayable;
        },

        /*
         * filters by the supplied text string
         * ignore if blank
         */
        _eventHasText: function (event) {
          // if they have not entered any text then we dont include this in the filter
          if (this.textFilter === undefined || this.textFilter == "") {
            return true;
          }

          var _displayable = false;

          // case insensitive search
          if (-1 !== event.name.toLowerCase().indexOf(this.textFilter.toLowerCase())) {
            _displayable = true;
          }
          return _displayable;
        },



        /*
         * the filter selection has been changed - refilter the data for display
         */
        refilterData: function () {
          // we dont refilter before the data is set
          if (this.allEvents == undefined) {
            return;
          }

          var that = this;
          var processedEvents = [];

          var output = [];

          // clear the display data
          this.displayableEvents = [];

          // for each event, check if the filters allow display
          this.allEvents.forEach(function (label) {
            label.events.forEach(function (e) {
              if (that._eventIsOnAFilteredCampus(e)
                      && that._eventIsInAFilteredMonth(e)
                      && that._eventHasText(e)
              ) {
                if (!processedEvents[label.id]) {
                  label.events = [];
//                  label.displayName = label.name.replace(/.*\./ , '');

                  processedEvents[label.id] = label;
                }

                if (!label.events)
                  label = processedEvents[label.id];

                //create display string for start date
                var startDate = new Date(event.start);
                event.formattedDate = startDate.toDateString();

                //add this event to the array of labels
                label.events.push(e);
              }
            });
          });
          this.displayableEvents = processedEvents;
          this.fire('training-filter', this.displayableEvents);
        }

      });
    })();
  </script>

</dom-module>
