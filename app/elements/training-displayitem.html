<link rel="import" href="elements.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="training-filter.html">
<script src="../scripts/md5.js"></script>

<dom-module id="training-displayitem">
  <style is="custom-style" include="common-styles">
    span {
      padding: 0 8px;
    }

    .eventDetails {
      margin-left: 2em;
    }


  </style>

  <template>

    <div on-tap="_openEvent">

      <paper-item>
        <span>Component: [[e.startDateFormatted]] </span>
        <span> [[e.name]] </span>
        <span> ([[ e.categories.campus ]])</span>
        <paper-icon-button icon="expand-less" hidden$="[[e.expandBlock]]"></paper-icon-button>
        <paper-icon-button icon="expand-more" hidden$="[[!e.expandBlock]]"></paper-icon-button>
      </paper-item>

      <!-- TODO what paper element should this block be? -->
      <div class="eventDetails" hidden$="[[e.expandBlock]]">
        <div>[[e.summary]]</div>
        <p>Venue: [[e.venue]]</p>

        <div hidden$="[[!e.areBookingsOpen]]">
          <p hidden$="[[e.canPublishPlaces">Places available: [[e.bookingSettings.placesRemaining]] of
                [[e.bookingSettings.bookingLimit]]</p>
          <p>Bookings Close: [[e.dateBookingsClose_formatted]]</p>
        </div>
        <div class="book">
          <a href="">
            <paper-button class="button-secondary">Log in and book</paper-button>
          </a>
        </div>

      </div>
    </div>
  </template>

  <script>
    (function () {
      Polymer({
        is: 'training-displayitem',

        properties: {
          /*
           * the incoming data
           */
          data: {
            type: Object,
            observer: '_formatData'
          },

          e: {
            type: Object,
            value: {}
          }
        },

        ready: function () {
        },

        _formatData: function (_event) {
          var _now = new Date();

          _event.startDateFormatted = "";

          _event.expandBlock = true;

          _event.dateBookingsClose_formatted = "";
          if (_event.bookingSettings !== undefined
                  && _event.bookingSettings !== null
                  && _event.bookingSettings.bookingsClose !== undefined) {
            _event.dateBookingsClose_formatted = moment(_event.bookingSettings.bookingsClose).format("ddd D MMM h:mma");
          }

          _event.dateBookingsClose_formatted = "";
          if (_event.bookingSettings !== undefined
                  && _event.bookingSettings !== null
                  && _event.bookingSettings.bookingsClose !== undefined) {
            _event.dateBookingsClose_formatted = moment(_event.bookingSettings.bookingsClose).format("ddd D MMM h:mma");
          }

          _event.areBookingsOpen = false;
          _event.canPublishPlaces = false;
          if (_event.bookingSettings !== undefined
                  && _event.bookingSettings !== null) {

            // can we show the bookings block?
            if (_event.bookingSettings.bookingsOpen !== undefined) {
              var _dateBookingsOpen = new Date(_event.bookingSettings.bookingsOpen);
              if (_dateBookingsOpen <= _now) {
                _event.areBookingsOpen = true;
              }
            }

            // can we show the number of places available?
            if (_event.bookingSettings.bookingLimit !== undefined && _event.bookingSettings.bookingLimit >0
                    && _event.bookingSettings.placesRemaining !== undefined && _event.bookingSettings.placesRemaining >0)
              _event.canPublishPlaces = true;
          }

          // setup the formatted date for display
          if (_event.start) {
            _event.startDateFormatted = moment(_event.start).format('ddd D MMM YYYY');
          }

          this.e = _event;
        },



        /*
         * collapses and opens the details of the training event
         */
//        that.set("selectedCampusList." + index + ".selected", true);
        _openEvent: function(ev, index) {
console.log("=====\ncomponent");
console.log(this.e);
//console.log(ev);
//console.log(index);
//console.log(this.$.expandBlock);
//          var _id = "ev." + index + ".expandBlock";
          var _id = "this.e.expandBlock";
          var _newvalue = !this.e.expandBlock;
          this.set(_id, _newvalue);
        }

      });
    })();
  </script>

</dom-module>
