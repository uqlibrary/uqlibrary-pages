<dom-module id="training-by-category">

  <link rel="import" href="elements.html">
  <link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
  <link rel="import" href="../bower_components/paper-input/paper-input.html">
  <link rel="import" href="../bower_components/paper-card/paper-card.html">
  <link rel="import" href="../bower_components/paper-item/paper-item.html">
  <link rel="import" href="../bower_components/paper-button/paper-button.html">
  <link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
  <link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
  <link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
  <link rel="import" href="../bower_components/uqlibrary-training/elements/uqlibrary-training-details.html">
  <script src="../scripts/md5.js"></script>

  <style is="custom-style" include="common-styles">
    :host {
      font-family: var(--font-family);
      font-size: var(--body-font-size);
    }

    .filter {
      font-size: 1.1em;
    }

    span {
      padding: 0 8px;
    }

    paper-card {
      margin-bottom: 16px;
    }

    .filter {
      margin: 8px 16px;
    }

    .event-date {
      min-width: 120px;
      cursor: default;
    }
    .event-link {
      cursor: pointer;
      padding-left: 20px;
    }

    .card-active {
      background: #e1e1e1;
    }

    /deep/ .content-icon.paper-icon-item
   {
      min-width: 40px;
      width: 40px;
   }
    /deep/ .header.uqlibrary-training-details
    {
      display: none;
    }

    /deep/ .subhead.uqlibrary-training-details
   {
       font-size: 2em;
   }

  </style>

  <template>
    <uqlibrary-api-account id="accountApi" on-uqlibrary-api-account-loaded="userAccountLoaded"></uqlibrary-api-account>
    <uqlibrary-api-training id="trainingApi" on-uqlibrary-api-training="_processData"></uqlibrary-api-training>

    <paper-card>
      <div class="header style-scope paper-card layout horizontal" on-click="toggle">
        <div class="title-text style-scope paper-card flex">Filter events</div>
        <paper-icon-button class="no-flex" style="margin: 10px" icon="icons:arrow-drop-down"></paper-icon-button>
      </div>

      <iron-collapse id="collapseFilter">
        <div class="card-content layout horizontal wrap">

          <div class="filter flex-3">
            <h4>Filter by keyword</h4>
            <div class="layout horizontal center-justified">
              <paper-input label="Keyword" class="flex-11"></paper-input>
              <paper-button class="flex-1">Search</paper-button>
            </div>
          </div>

          <div class="filter flex-3">
            <h4>Filter by campus</h4>
            <template is="dom-repeat" items="{{campusList}}" as="campus">
              <div>
                <paper-checkbox checked="{{campus.checked}}" on-change="filterEvents">{{campus.name}}</paper-checkbox>
              </div>
            </template>
          </div>

          <div class="filter flex-3">
            <h4>Filter by month</h4>

            <template is="dom-repeat" items="{{monthList}}" as="month">
              <div>
                <paper-checkbox checked="{{month.checked}}" on-change="filterEvents">{{month.name}}</paper-checkbox>
              </div>
            </template>
          </div>

        </div>
        <div class="card-actions layout horizontal end-justified">
          <paper-button>clear filters</paper-button>
        </div>
      </iron-collapse>
    </paper-card>

    <template is="dom-repeat" items="{{trainingEventsByCategory}}" as="category">

      <paper-card heading="{{category.displayName}}">

          <template is="dom-repeat" items="{{category.events}}" as="trainingEvent">
            <paper-item on-click="toggle">
              <div class="event-date">[[trainingEvent.formattedDate]]</div>
              <div class="event-link flex"><a>[[trainingEvent.name]] ([[ trainingEvent.categories.campus ]])</a></div>
              <paper-ripple></paper-ripple>
            </paper-item>

            <iron-collapse id$="collapse[[trainingEvent.entityId]]" opened="{{showEvent(trainingEvent.entityId)}}">
              <div class="card-active">
              <div class="card-content">

              <paper-card>
                <uqlibrary-training-details event="[[trainingEvent]]"></uqlibrary-training-details>
                <div class="card-content">
                  [Proper text required: ] Non-uq users should <a id$="event[[trainingEvent.entityId]]" href="#" on-click="sendEmail">submit expression of interest</a> to attend the event, or send email to training_events@library.uq.edu.au with event details and your name.</div>

                <div class="card-actions layout horizontal end-justified">
                  <paper-button class="button-colored-accent">
                    <a href="https://careerhub.uq.edu.au/students/events/detail/[[trainingEvent.entityId]]">
                    Login and book
                  </a>
                  </paper-button>
                </div>

              </paper-card>
              </div>
              </div>
            </iron-collapse>

          </template>

      </paper-card>

    </template>

  </template>

  <script>
    (function() {
      Polymer({
        is: 'training-by-category',

        properties: {

          trainingEvents: {
            type: Array,
            value: function() {
              return undefined;
            }
          },

          trainingEventsByCategory: {
            type: Array,
            value: function() {
              return undefined;
            }
          },

          campusList: {
            type: Array,
            value: function() {
              return [];
            }
          },

          monthList: {
            type: Array,
            value: function() {
              return [];
            }
          },

          filterByCampus: {
            type: Array,
            value: function() { return []; }
          },

          filterByMonth: {
            type: Array,
            value: function() { return []; }
          },

          searchKeyword: {
            type: String
          },

          eventId: {
            type: Number,
            value: function() {
              if (window.location.search.indexOf('eventId=') > 0) {
                var query = window.location.search.substring(1);
                var vars = query.split("&");
                for (var i = 0; i < vars.length; i++) {
                  var pair = vars[i].split("=");
                  if (pair[0] === 'eventId') {
                    return Number(pair[1]);
                  }
                }
              }

              return undefined;
            }
          },

          /**
           * Holds the user account
           */
          userAccount: {
            type: Object,
            value: function() {
              return undefined;
            },
            notify: true
          }
        },

        observers: [
          'registerAfterLogin(eventId, userAccount, trainingEvents)'
        ],

        filterEvents: function() {
          // todo: filter events by month/keyword/campus
        },

        registerAfterLogin: function(eventId, account, events) {
          var trainingEvent;

          for(var index = 0; index < events.length; index++) {
            if (events[index].entityId === eventId) {
              trainingEvent = events[index];
              break;
            }
          }

          if (trainingEvent)
            this.sendEmail(trainingEvent);
        },

        toggle: function(event) {

          var toggleId = 'collapseFilter';

          if (event.model && event.model.trainingEvent) {
            toggleId = 'collapse' + event.model.trainingEvent.entityId;
          }

          //close all other toggles
          var openedItems = this.querySelectorAll('.iron-collapse-opened');
          for(var index = 0; index < openedItems.length; index++) {
            var item = openedItems[index];
            //do not toggle current item or filter
            if (item.id.indexOf(toggleId) < 0 && item.id != 'collapseFilter')
              item.toggle();
          }

          this.querySelector('#' + toggleId).toggle();
        },

        sendEmail: function(e) {

          var trainingEvent = e.model ? e.model.trainingEvent : e;

          if (this.userAccount.hasSession) {
            //user is logged in, create email template
            var mailText = 'mailto:training_events@library.uq.edu.au?';
            mailText += '&subject=Expression of interest for event';
            mailText += '&body=Hi, \nI\'d like to participate in the following training event: \n\n';
            mailText += 'Event Id: ' + trainingEvent.entityId + '\n';
            mailText += 'Event Title: ' + trainingEvent.name + '\n';
            mailText += 'Event Date: ' + trainingEvent.formattedDate + ' (' + trainingEvent.start + ')' + '\n';
            mailText += 'Username: ' + this.userAccount.id + '\n';
            mailText += 'Name: ' + this.userAccount.name + '\n';
            mailText += 'Email: ' + this.userAccount.mail + '\n';
            mailText += '\n\nThank you' + '\n';

            window.location = encodeURI(mailText);

          } else {
            //user is not logged in, redirect to login page
            var href = window.location.href;
            if (href.indexOf('?') > 0)
              href = href.substr(0, href.indexOf('?'));
            this.$.accountApi.login(href + '?eventId=' + trainingEvent.entityId + '#' + trainingEvent.entityId);
          }

        },

        showEvent: function(id) {
          return this.eventId === id ? 'opened' : '';
        },

        ready: function() {
          this.$.trainingApi.get();
          this.$.accountApi.get();
        },

        /**
         * Called when the account was loaded
         * @param e
         * @private
         */
        userAccountLoaded: function (e) {
          if (e.detail.hasSession) {
            this.userAccount = e.detail;
          }
        },

        _processData: function(e) {
          var events = e.detail;

          var processedEvents = [];
          var categories = [];

          var campuses = [];
          var campusesIndex = [];

          var months = [];
          var monthsIndex = [];

          for(var eventIndex = 0; eventIndex < events.length; eventIndex++){
            var event = events[eventIndex];

            //set up all categories
            if (event.labels) {
              for(var labelIndex = 0; labelIndex < event.labels.length; labelIndex++) {
                var category = event.labels[labelIndex];

                var catIndex = categories.indexOf(category.id);

                if (catIndex < 0) {
                  category.events = [];
                  category.displayName = category.name.replace(/.*\./ , '');
                  processedEvents.push(category);

                  categories.push(category.id);
                  catIndex = categories.length - 1;
                }

                if (!category.events) {
                  category = processedEvents[catIndex];
                }

                //create display string for start date
                var startDate = new Date(event.start);
                event.formattedDate = moment(event.start).format('ddd D MMM YYYY');

                //add this event to the category
                category.events.push(event);
              }
            }

            //setup all campuses
            if (event.categories && event.categories.campus) {
              for(var index=0; index < event.categories.campus.length; index++) {
                var campus = event.categories.campus[index];

                if (campusesIndex.indexOf(campus) < 0) {
                  campusesIndex.push(campus);
                  campuses.push({
                    'checked' : 'checked',
                    'name' : campus
                  });
                }
              }
            }

            //setup all event months
            var monthName = moment(event.start).format('MMM YYYY');
            if (monthsIndex.indexOf(monthName) < 0) {
              monthsIndex.push(monthName);
              months.push({
                      'checked' : 'checked',
                      'name' : monthName
                    });
            }

          }

          this.trainingEventsByCategory = processedEvents;
          this.trainingEvents = events;
          this.campusList = campuses;
          this.monthList = months;
        }

      });
    })();
  </script>

</dom-module>
