<dom-module id="training-by-category">

  <link rel="import" href="elements.html">
  <link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
  <link rel="import" href="../bower_components/paper-input/paper-input.html">
  <link rel="import" href="../bower_components/paper-card/paper-card.html">
  <link rel="import" href="../bower_components/paper-button/paper-button.html">
  <link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
  <link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
  <link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
  <script src="../scripts/md5.js"></script>

  <style is="custom-style" include="common-styles">
    span {
      padding: 0 8px;
    }

    paper-card {
      margin-bottom: 16px;
    }

    .filter {
      margin: 8px 16px;
    }
  </style>

  <template>
    <uqlibrary-api-training id="trainingApi" on-uqlibrary-api-training="_processData"></uqlibrary-api-training>

    <paper-card>
      <div class="header style-scope paper-card layout horizontal">
        <div class="title-text style-scope paper-card flex">Filter events</div>
        <paper-icon-button class="no-flex" style="margin: 10px" icon="icons:arrow-drop-down" on-click="toggle"></paper-icon-button>
      </div>

      <iron-collapse id="collapse">
        <div class="card-content layout horizontal wrap">

          <div class="filter flex-3">
            <h4>Filter by keyword</h4>
            <div class="layout horizontal center-justified">
              <paper-input label="Keyword" class="flex-11"></paper-input>
              <paper-button class="flex-1">Search</paper-button>
            </div>
          </div>

          <div class="filter flex-3">
            <h4>Filter by campus</h4>
            <template is="dom-repeat" items="{{campusList}}" as="campus">
              <div>
                <paper-checkbox checked>{{campus}}</paper-checkbox>
              </div>
            </template>
          </div>

          <div class="filter flex-3">
            <h4>Filter by month</h4>

            <div>
              <paper-checkbox checked>Aug 2016</paper-checkbox>
            </div>
            <div>
              <paper-checkbox checked>Sep 2016</paper-checkbox>
            </div>
            <div>
              <paper-checkbox checked>Oct 2016</paper-checkbox>
            </div>
            <div>
              <paper-checkbox checked>Oct 2016</paper-checkbox>
            </div>
          </div>

        </div>
        <div class="card-actions layout horizontal end-justified">
          <paper-button>clear filters</paper-button>
        </div>
      </iron-collapse>
    </paper-card>

    <template is="dom-repeat" items="{{trainingEvents}}" as="category">

      <paper-card heading="{{category.displayName}}">
        <div class="card-content">

          <template is="dom-repeat" items="{{category.events}}" as="trainingEvent">
            <paper-item>
              <span> [[trainingEvent.formattedDate]] </span>
              <span><a href="#">[[trainingEvent.name]] ([[ trainingEvent.categories.campus ]])</a></span></paper-item>
          </template>

        </div>
      </paper-card>

    </template>


  </template>

  <script>
    (function() {
      Polymer({
        is: 'training-by-category',

        properties: {

          trainingEvents: {
            type: Array
          },

          campusList: {
            type: Array
          }

        },

        toggle: function() {
          this.$.collapse.toggle();
        },
        ready: function() {
          this.$.trainingApi.get();
        },

        _processData: function(e) {
          var events = e.detail;
          var campuses = [];
          var processedEvents = [];
          var categories = [];


          events.forEach(function(event){
            //set up all categories
            if (event.labels) {
              event.labels.forEach(function(category){

                var catIndex = categories.indexOf(category.id);

                if (catIndex < 0) {
                  category.events = [];
                  category.displayName = category.name.replace(/.*\./ , '');
                  processedEvents.push(category);

                  categories.push(category.id);
                  catIndex = categories.length - 1;
                }

                if (!category.events) {
                  category = processedEvents[catIndex];
                }

                //create display string for start date
                var startDate = new Date(event.start);
                event.formattedDate = startDate.toDateString();

                //add this event to the category
                category.events.push(event);
              });
            }

            //setup all campuses
            if (event.categories && event.categories.campus) {
              event.categories.campus.forEach(function(campus){
                if (campuses.indexOf(campus) < 0) {
                  campuses.push(campus);
                }
              });
            }

          });

          this.trainingEvents = processedEvents;
          this.campusList = campuses;
        }

      });
    })();
  </script>

</dom-module>
