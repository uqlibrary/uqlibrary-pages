<link rel="import" href="elements.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<script src="../scripts/md5.js"></script>

<dom-module id="prototype-4">
  <style is="custom-style" include="common-styles">
    span {
      padding: 0 8px;
    }

    paper-card {
      padding: 1em;
      margin-bottom: 1em;
    }

    #textFilter {
      width: 15em;
    }

    /* control hide-show */
/*
    .block {
      display: none;
    }
    .block.expanded  {
      display: block;
    }
*/
    @media all and (min-width: 700px) {
      /* if we have a wide enough screen, keep the checkboxes with the label */
      #selectCampus,
      #selectMonth {
        white-space: nowrap;
      }
    }
    @media all and (max-width: 700px) {
      #selectCampus,
      #selectMonth {
        display: block;
      }
    }

  </style>

  <template>
    <uqlibrary-api-training id="trainingApi" on-uqlibrary-api-training="_setupData"></uqlibrary-api-training>

    <paper-card elevation="1" id="filter">
      <span id="selectCampus">
        <template is="dom-if" if="[[areMultipleCampuses]]">
          <span>Choose a campus:</span>
          <template id="campustemplate" is="dom-repeat" items="{{selectedCampusList}}" as="campus">
            <paper-checkbox checked="{{campus.selected}}" on-change="refilterData">{{campus.name}}</paper-checkbox>
          </template>
        </template>
        <template is="dom-if" if="[[!areMultipleCampuses]]">
          <p>Training events currently only at: {{campusList}}</p>
        </template>
      </span>

      <span id="selectMonth">
        <template is="dom-if" if="[[areMultipleMonths]]">
          <span>Choose a month:</span>
          <template is="dom-repeat" items="{{selectedMonthList}}" as="month">
            <paper-checkbox checked="{{month.selected}}" on-change="refilterData">{{month.display}}</paper-checkbox>
          </template>
        </template>
        <template is="dom-if" if="[[!areMultipleCampuses]]">
          <p>Training events currently only at: {{campusList}}</p>
        </template>
      </span>

      <span id="textFilter">
        <paper-input id="textFilter" placeholder="Restrict result by text" value="{{textFilter}}"></paper-input>
      </span>

      <paper-button on-tap="resetFilters">Reset filters</paper-button>

    </paper-card>


    <paper-card elevation="1">
      <template is="dom-repeat" items="{{displayedEvents}}" as="e">
        <paper-item>
          <span> [[e.startDateFormatted]] </span>
          <span> [[e.name]] </span>
          <span> ([[ e.categories.campus ]])</span>
          <paper-icon-button on-tap="expandTheBlock" icon="more-horiz"></paper-icon-button>
<!--
          <paper-icon-button toggles="{{expandTheBlock(e)}}" icon="more-horiz"></paper-icon-button>
          info-outline
          reorder
          star-border
          icons:visibility
 -->

        </paper-item>

        <paper-item hidden$="{{!e.expandBlock}}">
          <span> [[e.summary]] </span>
        </paper-item>
      </template>

    </paper-card>

  </template>

  <script>
    (function () {
      Polymer({
        is: 'prototype-4',

        properties: {

          /*
           * all the campuses that are provided in the data
           * (matches to filter options displayed)
           */
          displayCampusList: {
            type: Array,
            value: []
          },
          selectedCampusList: {
            type: Array,
            value: [],
            notify: true
          },
          areMultipleCampuses: Boolean,


          displayMonthList: {
            type: Array,
            value: []
          },
          selectedMonthList: {
            type: Array,
            value: [],
            notify: true
          },
          areMultipleMonths: Boolean,

          textFilter: {
            type: String,
            observer: "refilterData"
          },

          _ironAllyTarget: {
            type: Object,
            value: function () {
              return this.$.textFilter;
            }
          },


          displayedEvents: {
            type: Array
          },

          allEvents: {
            type: Array
          }


        },

        ready: function () {
          this.$.trainingApi.get();
        },

        expandTheBlock: function(ev, index) {
console.log("in expandTheBlock for "+ev.model.e.name);
          console.log(ev.model.index);
//          ev.model.e.expandBlock = !ev.model.e.expandBlock;
//          ev.model.e.set("expandBlock", !ev.model.e.expandBlock);
//          this.set("ev.model.e.expandBlock", !ev.model.e.expandBlock);
          this.set("allEvents." + ev.model.index + ".expandBlock", true);
//          return ev.model.e.expandBlock;
        },

        getClassForItem: function(_selected) {
console.log("in getClassForItem - input (selected) = "+_selected);
          var _val = _selected ? 'block expanded' : 'block';
console.log(_val)
          return _val;
        },

        /*
         * setup the data on first load
         */
        _setupData: function (e) {
          var events = e.detail;
          var campuses = [];
          var months = [];

          var that = this;

          // extract all the filter collections
          events.forEach(function (event) {
            event.startDateFormatted = "";
            event.filterDate = "";

console.log("initiallising expandBlock for "+event.name+" to false");
            event.expandBlock = false;

            // setup the formatted date for display
            if (event.start) {
              event.startDateFormatted = moment(event.start).format('ddd D MMM YYYY');
              event.filterDate = moment(event.start).format('MMM YYYY');
            }


            if (event.categories && event.categories.campus) {
              event.categories.campus.forEach(function (campus) {
                if (campuses.indexOf(campus) < 0) {
                  campuses.push(campus);
                }
              });
            }

            if (months !== undefined && event.filterDate != "" && months.indexOf(event.filterDate) < 0) {
              months.push(event.filterDate);
            }

          });

          // store the possible list of campuses
          this.displayCampusList = campuses;
          this.areMultipleCampuses = (this.displayCampusList !== undefined && this.displayCampusList.length > 1);

          // initially select all campus options
          campuses.forEach(function (aCampus) {
            var newCampus = {};
            newCampus.name = aCampus;
            newCampus.selected = true;
            that.selectedCampusList.push(newCampus);
          });

          this.displayMonthList = months;
          this.areMultipleMonths = (this.displayMonthList !== undefined && this.displayMonthList.length > 1);
          // initially select all months
          months.forEach(function (aMonth) {
            var newMonth = {};
            newMonth.display = aMonth;
            newMonth.selected = true;
            that.selectedMonthList.push(newMonth);
          });

          // filters are 'select all' initially
          this.displayedEvents = events;

          this.allEvents = events;
        },
        /*
         // various attempts
         resetCampus: function(campus, index, _selected=true) {
         var _theCampus = {};
         _theCampus = this.selectedCampusList[index];
         this.$.selectedCampusList[index].selected = true;
         },

         resetCampus1: function(oldValue, newValue, index) {
         this.notifySplices("selectedCampusList", [
         {
         index: index,
         removed: [oldValue],
         addedCount: 1,
         object: newValue
         }]);
         },
         */

        /*
         * resets all the filters to their default position
         * and redisplaysthe curr
         */
        resetFilters: function () {
          var that = this;
          this.selectedCampusList.forEach(function (c, index) {
            that.set("selectedCampusList." + index + ".selected", true);
          });

          this.selectedMonthList.forEach(function (m, index) {
            that.set("selectedMonthList." + index + ".selected", true);
          });

          that.set("textFilter", "");

          this.refilterData();
        },

        /*
         * if the campus of the event matches one of the campuses selected in the filter, return true
         * otherwise, return false
         * we are assuming there is only ever one entry in event.categories.campus
         */
        _eventIsOnAFilteredCampus: function (_event) {
          if (!(_event.categories && _event.categories.campus)) {
            return false;
          }

          eventCampus = _event.categories.campus;

          var _displayable = false;
          if (this.selectedCampusList !== undefined && 0 < this.selectedCampusList.length) {
            this.selectedCampusList.forEach(function (campusFilter) {
              if (eventCampus == campusFilter.name && campusFilter.selected) {
                _displayable = true;
              }
            });
          }
          return _displayable;
        },

        /*
         * returns true if the event's start date is currently ticked in the filter
         */
        _eventIsInAFilteredMonth: function (event) {
          var _displayable = false;
          if (this.selectedMonthList !== undefined && 0 < this.selectedMonthList.length) {
            this.selectedMonthList.forEach(function (monthFilter) {
              if (event.filterDate && event.filterDate == monthFilter.display
                      && monthFilter.selected) {
                _displayable = true;
              }
            });
          }
          return _displayable;
        },

        _eventHasText: function (event) {
          // if they have not entered any text then we dont include this in the filter
          if (this.textFilter === undefined || this.textFilter == "") {
            return true;
          }

          var _displayable = false;

          // case insensitive search
          if (-1 !== event.name.toLowerCase().indexOf(this.textFilter.toLowerCase())) {
            _displayable = true;
          }
          return _displayable;
        },



        /*
         * the filter selection has been changed - refilter the data for display
         */
        refilterData: function () {
          // we dont refilter before the data is set
          if (this.allEvents == undefined) {
            return;
          }

          var that = this;
          var processedEvents = [];

          // clear the display data
          this.displayedEvents = [];

          // for each event, check if the filters allow display
          this.allEvents.forEach(function (e) {
            if (that._eventIsOnAFilteredCampus(e)
                    && that._eventIsInAFilteredMonth(e)
                    && that._eventHasText(e)
            ) {
              processedEvents.push(e);
            }
          });
          this.displayedEvents = processedEvents;

        },


        _formatLabelForDisplay: function (aName) {
          var _labeldisplay = aName;
          var _positionDot = aName.lastIndexOf(".");
          if (-1 !== _positionDot) {
            _labeldisplay = aName.substr(_positionDot + 1);
          }
          return _labeldisplay;
        }


      });
    })();
  </script>

</dom-module>
