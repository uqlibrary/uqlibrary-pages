<link rel="import" href="elements.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<script src="../scripts/md5.js"></script>

<dom-module id="prototype-4">
  <style is="custom-style" include="common-styles">
    span {
      padding: 0 8px;
    }

    paper-card {
      padding: 1em;
      margin-bottom: 1em;
    }


  </style>

  <template>
    <uqlibrary-api-training id="trainingApi" on-uqlibrary-api-training="_setupData"></uqlibrary-api-training>

    <paper-card elevation="1" id="filter">
      <div id="selectCampus">
        <template is="dom-if" if="[[areMultipleCampuses]]">
          <span>Choose a campus:</span>
          <template id="campustemplate" is="dom-repeat" items="{{selectedCampusList}}" as="campus">
            <paper-checkbox checked="{{campus.selected}}" on-change="refilterData">{{campus.name}}</paper-checkbox>
          </template>
        </template>
        <template is="dom-if" if="[[!areMultipleCampuses]]">
          <p>Training events currently only at: {{campusList}}</p>
        </template>
      </div>

      <div id="selectMonth">
        <template is="dom-if" if="[[areMultipleMonths]]">
          <span>Choose a month:</span>
          <template is="dom-repeat" items="{{selectedMonthList}}" as="month">
            <paper-checkbox checked="{{month.selected}}" on-change="refilterData">{{month.display}}</paper-checkbox>
          </template>
        </template>
        <template is="dom-if" if="[[!areMultipleCampuses]]">
          <p>Training events currently only at: {{campusList}}</p>
        </template>
      </div>

      <div>text filter tbd</div>

      <paper-button  on-tap="resetFilters">Reset filters</paper-button>

    </paper-card>



    <paper-card elevation="1">
        <template is="dom-repeat" items="{{displayedEvents}}" as="displayedEvent">
          <paper-item>
            <span> [[displayedEvent.startDateFormatted]] </span>
            <span> [[displayedEvent.name]] </span>
            <span> ([[ displayedEvent.categories.campus ]])</span>

            <paper-button on-tap="xxx">Expand</paper-button>
          </paper-item>
        </template>

    </paper-card>

  </template>

  <script>
    (function() {
      Polymer({
        is: 'prototype-4',

        properties: {

          /*
           * all the campuses that are provided in the data
           * (matches to filter options displayed)
           */
          displayCampusList: {
            type: Array,
            value: []
          },
          selectedCampusList: {
            type: Array,
            value: [],
            notify: true
          },
          areMultipleCampuses: Boolean,


          displayMonthList: {
            type: Array,
            value: []
          },
          selectedMonthList: {
            type: Array,
            value: [],
            notify: true
          },
          areMultipleMonths: Boolean,


          displayedEvents: {
            type: Array
          },

          allEvents: {
            type: Array
          }


        },
/*
        observers: [
         'filterChangeCampus(selectedCampusList.selected)',
         'filterChangeMonth(selectedMonthList.selected)'
        ],

        filterChangeCampus: function (_selected) {
         this.set(selectedCampusList.selected) = _selected;
        },
        filterChangeMonth: function (_selected) {
         this.set(selectedMonthList.selected) = _selected;
        },
*/

        ready: function() {
          this.$.trainingApi.get();
        },

        /*
         * setup the data on first load
         */
        _setupData: function(e) {
          var events = e.detail;
          var campuses = [];
          var months = [];

          var that = this;

          // extract all the filter collections
          events.forEach(function(event){
            event.startDateFormatted = "";
            event.filterDate = "";
            // setup the formatted date for display
            if (event.start) {
              event.startDateFormatted = moment(event.start).format('ddd D MMM YYYY');
              event.filterDate = moment(event.start).format('MMM YYYY');
            }


            if (event.categories && event.categories.campus) {
              event.categories.campus.forEach(function(campus){
                if (campuses.indexOf(campus) < 0) {
                  campuses.push(campus);
                }
              });
            }

            if (months!== undefined && event.filterDate != "" && months.indexOf(event.filterDate) < 0) {
              months.push(event.filterDate);
            }

          });

          // store the possible list of campuses
          this.displayCampusList = campuses;
          this.areMultipleCampuses = (this.displayCampusList !== undefined && this.displayCampusList.length > 1);

          // initially select all campus options
          campuses.forEach(function (aCampus) {
            var newCampus = {};
            newCampus.name = aCampus;
            newCampus.selected = true;
            that.selectedCampusList.push(newCampus);
          });

          this.displayMonthList = months;
          this.areMultipleMonths = (this.displayMonthList !== undefined && this.displayMonthList.length > 1);
          // initially select all months
          months.forEach(function (aMonth) {
            var newMonth = {};
            newMonth.display = aMonth;
            newMonth.selected = true;
            that.selectedMonthList.push(newMonth);
          });

          // filters are 'select all' initially
          this.displayedEvents = events;

          this.allEvents = events;
        },

        /*
         * resets all the filters to their default position
         */
        resetFilters: function() {
          var that = this;
          this.selectedCampusList.forEach(function(campus) {
//            c.set("c.selected", true);
            campus.selected = true;
            that.set("campus.selected", true);
          });
          this.selectedMonthList.forEach(function(m) {
            m.selected = true;
//            m.set("selected", true);
          });

          // todo text field

//          this.$.campustemplate.render();

          this.refilterData();
        },

        /*
         * if the campus of the event matches one of the campuses selected in the filter, return true
         * otherwise, return false
         * we are assuming there is only ever one entry in event.categories.campus
         */
        _eventIsOnASelectedCampus: function(_event) {
          if (!(_event.categories && _event.categories.campus)) { return false; }

          eventCampus = _event.categories.campus;

          var _displayable = false;
          if (this.selectedCampusList !== undefined && 0 < this.selectedCampusList.length) {
            this.selectedCampusList.forEach(function (campusFilter) {
              if (eventCampus == campusFilter.name && campusFilter.selected) {
                _displayable = true;
              }
            });
          }
          return _displayable;
        },

        /*
         * returns true if the event's start date is currently ticked in the filter
         */
        _eventIsInASelectedMonth: function(event) {
          var _displayable = false;
          if (this.selectedMonthList !== undefined && 0 < this.selectedMonthList.length) {
            this.selectedMonthList.forEach(function(monthFilter) {
              if (event.filterDate && event.filterDate == monthFilter.display
                      && monthFilter.selected) {
                _displayable = true;
              }
            });
          }
          return _displayable;
        },



        /*
         * the filter selection has been changed - refilter the data for display
         */
        refilterData: function() {
          var that = this;
          var processedEvents = [];

          // clear the display data
          this.displayedEvents = [];

          // for each event, check if the filters allow display
          this.allEvents.forEach(function(e) {
            if (that._eventIsOnASelectedCampus(e)
                && that._eventIsInASelectedMonth(e)
            // && text filter check TODO
            ) {
              processedEvents.push(e);

            }

          });
          this.displayedEvents = processedEvents;

        },



        _formatLabelForDisplay: function(aName) {
          var _labeldisplay = aName;
          var _positionDot = aName.lastIndexOf(".");
          if (-1 !== _positionDot) {
            _labeldisplay = aName.substr(_positionDot + 1);
          }
          return _labeldisplay;
        }


        });
    })();
  </script>

</dom-module>
