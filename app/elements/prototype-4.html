<link rel="import" href="elements.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="training-filter.html">
<link rel="import" href="training-displayitem.html">
<script src="../scripts/md5.js"></script>

<dom-module id="prototype-4">
  <style is="custom-style" include="common-styles">
    span {
      padding: 0 8px;
    }

    paper-card {
      padding: 1em;
      margin-bottom: 1em;
    }

  </style>

  <template>

    <paper-card elevation="1" id="filter">
      <training-filter id="trainingFilter" on-training-filter="_setupData"></training-filter>
    </paper-card>

    <template is="dom-repeat" items="[[labelsList]]" as="labelEntry">
      <paper-card elevation="1">

        <h2>[[labelEntry.displayName]]</h2>
<!--
        <template is="dom-repeat" items="[[labelEntry.events]]" as="e">
          <training-displayitem data="[[e]]"></training-displayitem>

          <!-- test duplication -!->
          <div on-tap="_toggleDetailDisplay">

            <paper-item>
              <span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Inline: [[e.startDateFormatted]] </span>
              <span> [[e.name]] </span>
              <span> ([[ e.categories.campus ]])</span>
              <paper-icon-button icon="expand-less" hidden$="[[e.expandBlock]]"></paper-icon-button>
              <paper-icon-button icon="expand-more" hidden$="[[!e.expandBlock]]"></paper-icon-button>
            </paper-item>

            <!-!- TODO what paper element should this block be? -!->
            <div class="eventDetails" hidden$="[[e.expandBlock]]">
              <div>[[e.summary]]</div>
              <p>Venue: [[e.venue]]</p>

              <div hidden$="[[!e.areBookingsOpen]]">
                <p hidden$="[[e.canPublishPlaces">Places available: [[e.bookingSettings.placesRemaining]] of
                  [[e.bookingSettings.bookingLimit]]</p>
                <p>Bookings Close: [[e.dateBookingsClose_formatted]]</p>
              </div>
              <div class="book">
                <a href="">
                  <paper-button class="button-secondary">Log in and book</paper-button>
                </a>
              </div>


            </div>
            <hr>
          </div>
        </template>
-->
      </paper-card>
    </template>

  </template>

  <script>
    (function () {
      Polymer({
        is: 'prototype-4',

        properties: {
          /*
           * the events that match the selected filters, returned from the filter component
           */
          labelsList: {
            type: Array,
            value: []
          }
        },

        ready: function () {
        },




        /*
         * collapses and opens the details of the training event
         */
        _toggleDetailDisplay: function(ev) {
          var _id = "labelsList." + ev.model.index + ".expandBlock";
          var _newvalue = !ev.model.e.expandBlock;
          this.set(_id, _newvalue);
        },



        /*
         * setup the data on first load
         */
        _setupData: function (e) {
          var list = e.detail;

          var _now = new Date();
          var that = this;

          // setup the display data for each item
          list.forEach(function (label) {
            label.events.forEach(function (_event) {
              _event.startDateFormatted = "";

              _event.expandBlock = true;

              _event.dateBookingsClose_formatted = "";
              if (_event.bookingSettings !== undefined
                      && _event.bookingSettings !== null
                      && _event.bookingSettings.bookingsClose !== undefined) {
                _event.dateBookingsClose_formatted = moment(_event.bookingSettings.bookingsClose).format("ddd D MMM h:mma");
              }

              _event.dateBookingsClose_formatted = "";
              if (_event.bookingSettings !== undefined
                      && _event.bookingSettings !== null
                      && _event.bookingSettings.bookingsClose !== undefined) {
                _event.dateBookingsClose_formatted = moment(_event.bookingSettings.bookingsClose).format("ddd D MMM h:mma");
              }

              _event.areBookingsOpen = false;
              _event.canPublishPlaces = false;
              if (_event.bookingSettings !== undefined
                      && _event.bookingSettings !== null) {

                // can we show the bookings block?
                if (_event.bookingSettings.bookingsOpen !== undefined) {
                  var _dateBookingsOpen = new Date(_event.bookingSettings.bookingsOpen);
                  if (_dateBookingsOpen <= _now) {
                    _event.areBookingsOpen = true;
                  }
                }

                // can we show the number of places available?
                if (_event.bookingSettings.bookingLimit !== undefined && _event.bookingSettings.bookingLimit > 0
                        && _event.bookingSettings.placesRemaining !== undefined && _event.bookingSettings.placesRemaining > 0)
                  _event.canPublishPlaces = true;
              }

              // setup the formatted date for display
              if (_event.start) {
                _event.startDateFormatted = moment(_event.start).format('ddd D MMM YYYY');
              }

            });

            // filters are 'select all' initially
            that.labelsList[label.id] = label;
          });
console.log(this.labelsList);
        }
      });
    })();
  </script>

</dom-module>
