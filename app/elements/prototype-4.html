<dom-module id="protoype-4">
  <link rel="import" href="elements.html">
  <link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
  <link rel="import" href="../bower_components/paper-input/paper-input.html">
  <link rel="import" href="../bower_components/paper-button/paper-button.html">

  <script src="../scripts/md5.js"></script>

  <style is="custom-style" include="common-styles">
    span {
      padding: 0 8px;
    }
  </style>

  <template>
    <uqlibrary-api-training id="trainingApi" on-uqlibrary-api-training="_processData"></uqlibrary-api-training>

    <div>
      <template is="dom-if" hidden$="{{!areMultipleCampuses}}">
        <template is="dom-repeat" items="{{campusList}}" as="campus">
          <paper-checkbox checked>{{campus}}</paper-checkbox>
        </template>
      </template>
    </div>

<!--
    <div>
      <template is="dom-if" hidden$="{{!areMultipleLabels}}">
        <template is="dom-repeat" items="{{labelList}}" as="label">
          <paper-checkbox checked>{{label}}</paper-checkbox>
        </template>
      </template>
    </div>
 -->

      <template is="dom-repeat" items="{{category.events}}" as="trainingEvent">
        <paper-item>
          <span> [[trainingEvent.formattedDate]] </span>
          <span><a href="#">[[trainingEvent.name]] ([[ trainingEvent.categories.campus ]])</a></span>
        </paper-item>
      </template>


  </template>

  <script>
    (function() {
      Polymer({
        is: 'prototype-4',

        properties: {

          trainingEvents: {
            type: Array
          },

          campusList: {
            type: Array
          },

          labelList: {
            type: Array
          }

        },

        ready: function() {
console.log("in ready");
          this.$.trainingApi.get();
        },

        _processData: function(e) {

          var events = e.detail;
          var campuses = [];
          var labels = [];
          var processedEvents = [];

          events.forEach(function(event){

            //set up all categories
            if (event.labels) {
              event.labels.forEach(function(category){
                if (!processedEvents[category.id]) {
                  category.events = [];
                  category.displayName = category.name.replace(/.*\./ , '');

                  processedEvents[category.id] = category;
                }

                if (!category.events)
                  category = processedEvents[category.id];

                //create display string for start date
                var startDate = new Date(event.start);
                event.formattedDate = startDate.toDateString();

                //add this event to the category
                category.events.push(event);

              });
            }

            //setup all campuses
            if (event.categories && event.categories.campus) {
              event.categories.campus.forEach(function(campus){
                if (campuses.indexOf(campus) < 0) {
                  campuses.push(campus);
                }
              });
            }

            //setup all labels
            if (event.labels) {
              event.labels.forEach(function(labelItem){
                if (labels.indexOf(labelItem.name) < 0) {
                  labels.push(labelItem.name);
                }
              });
            }

          });

          this.trainingEvents = processedEvents;
          this.campusList = campuses;
          this.labelList = labels;
        },

        areMultipleCampuses: function (){
          return this.campusList.length > 1;
        },

        areMultipleLabels: function (){
          return this.labelList.length > 1;
        }

      });
    })();
  </script>

</dom-module>
