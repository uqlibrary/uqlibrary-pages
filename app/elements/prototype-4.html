<link rel="import" href="elements.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="training-filter.html">
<link rel="import" href="training-displayitem.html">
<script src="../scripts/md5.js"></script>

<dom-module id="prototype-4">
  <style is="custom-style" include="common-styles">
    span {
      padding: 0 8px;
    }

    paper-card {
      padding: 1em;
      margin-bottom: 1em;
    }

  </style>

  <template>

    <paper-card elevation="1" id="filter">
      <training-filter id="trainingFilter" on-training-filter="_setupData"></training-filter>
    </paper-card>

    <paper-card elevation="1">
      <template is="dom-repeat" items="{{displayableEvents}}" as="e">
<!--
        <training-displayitem data="[[e]]"></training-displayitem>
 -->
        <div on-tap="_toggleDetailDisplay">

          <paper-item>
            <span> [[e.startDateFormatted]] </span>
            <span> [[e.name]] </span>
            <span> ([[ e.categories.campus ]])</span>
            <paper-icon-button icon="expand-less" hidden$="[[e.expandBlock]]"></paper-icon-button>
            <paper-icon-button icon="expand-more" hidden$="[[!e.expandBlock]]"></paper-icon-button>
          </paper-item>

          <!-- TODO what paper element should this block be? -->
          <div class="eventDetails" hidden$="[[e.expandBlock]]">
            <div>[[e.summary]]</div>
            <p>Venue: [[e.venue]]</p>

            <div hidden$="[[!e.areBookingsOpen]]">
              <p hidden$="[[e.canPublishPlaces">Places available: [[e.bookingSettings.placesRemaining]] of
                [[e.bookingSettings.bookingLimit]]</p>
              <p>Bookings Close: [[e.dateBookingsClose_formatted]]</p>
            </div>
            <div class="book">
              <a href="">
                <paper-button class="button-secondary">Log in and book</paper-button>
              </a>
            </div>


          </div>
        </div>

      </template>

    </paper-card>
  </template>

  <script>
    (function () {
      Polymer({
        is: 'prototype-4',

        properties: {
          /*
           * the events that match the selected filters
           */
          displayableEvents: Array
        },

        ready: function () {
        },

        /*
         * collapses and opens the details of the training event
         */
        _toggleDetailDisplay: function(ev) {
console.log(ev);
          var _id = "displayableEvents." + ev.model.index + ".expandBlock";
          var _newvalue = !ev.model.e.expandBlock;
          this.set(_id, _newvalue);
        },

        /*
         * setup the data on first load
         */
        _setupData: function (e) {
          var events = e.detail;

          var _now = new Date();

          // setup the display data for each item
          events.forEach(function (_event) {
            _event.startDateFormatted = "";

            _event.expandBlock = true;

            _event.dateBookingsClose_formatted = "";
            if (_event.bookingSettings !== undefined
                    && _event.bookingSettings !== null
                    && _event.bookingSettings.bookingsClose !== undefined) {
              _event.dateBookingsClose_formatted = moment(_event.bookingSettings.bookingsClose).format("ddd D MMM h:mma");
            }

            _event.dateBookingsClose_formatted = "";
            if (_event.bookingSettings !== undefined
                    && _event.bookingSettings !== null
                    && _event.bookingSettings.bookingsClose !== undefined) {
              _event.dateBookingsClose_formatted = moment(_event.bookingSettings.bookingsClose).format("ddd D MMM h:mma");
            }

            _event.areBookingsOpen = false;
            _event.canPublishPlaces = false;
            if (_event.bookingSettings !== undefined
                    && _event.bookingSettings !== null) {

              // can we show the bookings block?
              if (_event.bookingSettings.bookingsOpen !== undefined) {
                var _dateBookingsOpen = new Date(_event.bookingSettings.bookingsOpen);
                if (_dateBookingsOpen <= _now) {
                  _event.areBookingsOpen = true;
                }
              }

              // can we show the number of places available?
              if (_event.bookingSettings.bookingLimit !== undefined && _event.bookingSettings.bookingLimit >0
                      && _event.bookingSettings.placesRemaining !== undefined && _event.bookingSettings.placesRemaining >0)
                _event.canPublishPlaces = true;
            }

            // setup the formatted date for display
            if (_event.start) {
              _event.startDateFormatted = moment(_event.start).format('ddd D MMM YYYY');
            }

          });

          // filters are 'select all' initially
          this.displayableEvents = events;
        }

      });
    })();
  </script>

</dom-module>
